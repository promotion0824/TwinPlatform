name: Azure Docker
description: Build and Push Docker Image to Azure Container Registry

inputs:
  dockerfile:
    description: Relative path to dockerfile
    required: true
  dockerContext:
    description: docker context path
    required: true
  imageName:
    description: docker image name
    required: true
  acrName:
    description: Azure Container Registry Name
    required: true
  BuildNumber:
    description: Build Number
    required: true
  client_id:
    description: "Azure service principal client id to use"
    required: true
  tenant_id:
    description: "Azure service principal tenant id"
    required: true
  subscription_id:
    description: "Cluster subscription Id"
    required: true
  acr_resource_group:
    description: "Azure Container Registry Resource Group"
    required: true

runs:
  using: composite
  steps:
      
  - name: Set up Docker Buildx
    uses: docker/setup-buildx-action@v2

  - uses: azure/login@v1
    with:
      client-id: ${{ inputs.client_id }}
      tenant-id: ${{ inputs.tenant_id }}
      subscription-id: ${{ inputs.subscription_id }}

  - name: Login to acr
    shell: bash
    run: az acr login --name ${{ inputs.acrName }} --resource-group ${{ inputs.acr_resource_group }}

  - name: Build
    uses: docker/build-push-action@v4
    with:
      file: ${{ inputs.dockerfile }}
      context: ${{ inputs.dockerContext }}
      push: true
      tags: |
        ${{ inputs.acrName }}.azurecr.io/${{ inputs.imageName }}:${{ inputs.BuildNumber }}
        ${{ inputs.acrName }}.azurecr.io/${{ inputs.imageName  }}:latest
