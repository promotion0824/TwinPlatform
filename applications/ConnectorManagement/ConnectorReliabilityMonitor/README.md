# Connector Health Monitoring (MVP)

This document outlines a proposal for monitoring the health and status of data source connectors, focusing on raising alerts and taking action to address data outages promptly. It leverages OpenTelemetry for logging metrics, with alerting facilitated through Grafana to Zendesk.

https://willow.atlassian.net/wiki/spaces/RFC/pages/2619244557/Reliability+2.0+-+Data+Ingestion+Connector+Health


## Overview

### Goals and Motivations

- Implement monitoring and alerting for data ingestion as customers transition to Single Tenant environments.
- Develop Grafana dashboards to aggregate and display metrics from both edge devices and data ingestion processes.
- Extend monitoring and alerting capabilities to include Mapped data integrations.

## Design

The proposed solution involves a container app that periodically queries ADX tables for customer instances, logging custom metrics for observability in Grafana. These metrics will form the basis for alert conditions, triggering Zendesk tickets for resolution by the Customer Technical Support (CTS) team.

### Key Features

- The app will query ADX tables every 5 minutes by default.
- Metrics from existing edge connector integrations, sent via IoTHub, will be ingested for Grafana-based monitoring.
- Use of the `dtmi:com:willowinc:ConnectorApplication;1` Twin for common connector properties.
- Alert scenarios in Grafana based on metrics to trigger Zendesk tickets for actionable insights.

### Metrics of Interest

Metrics will include, but are not limited to, connector status (enabled/disabled), collection intervals, the number of enabled points, delta of enabled points, and telemetry data specifics like unique points collected and total telemetry values.

## Mapped Integrations

Mapped integrations use a fixed ConnectorId, with the MTI expected to create Connector Twins based on Mapped ConnectorIds. The health monitoring app will need to account for these details to accurately report metrics.

## Alert Scenarios

Configurable alert scenarios in Grafana will include full outages (no telemetry for X minutes), partial outages (below threshold% of points for X hours), and missing twins (capabilities without a matching twin exceeding a threshold).

## Alternatives and Prior Art

The existing function app only supports edge and marketplace connectors, requiring significant rework for single tenant contexts and Mapped connectors integration.

## Trade-offs and Risks

- Partial outage details will not include specific points not trending, as this information is currently generated by a separate API and emailed by the function app.
- Alerts will be generated from Grafana, avoiding logging excessive details as metrics.

## Security and Privacy

Metrics are logged to regional application insights/log analytics, consistent with other app-specific metrics logging practices.

## Implementation Plan

- Update the ConnectorApplication model in the ontology with new fields.
- Develop and deploy the container app for logging metrics.
- Create Grafana dashboards utilizing custom metrics logged by the app.
- Define Grafana-based alerts to be sent to Zendesk.

## Still To Do

- Finalize the list of metrics and the detailed design of the Grafana dashboards.
- Determine the feasibility of including additional query capabilities in Grafana for enhanced alert details.


# App Settings Configuration

The application is configured through the `appsettings.json` file, which includes settings for Azure Data Explorer (ADX), ADX queries, and Application Insights. Below is a detailed explanation of each section and how to configure them.

## ADX Configuration

Settings related to the Azure Data Explorer cluster and database the application will query.

```json
{
  "Adx": {
    "ClusterUri": "https://your-cluster-region.kusto.windows.net",
    "DatabaseName": "your-database-name"
  }
}
```

## ADX Queries Configuration

```json
{
  "AdxQueries": {
    "ConnectorUpdateIntervalSeconds": 300,
    "Queries": [
      {
        "Key": "ConnectorStateStatus",
        "Query": "ConnectorState | where IsArchived == false and IsEnabled == true and ConnectorId == \"{{ConnectorId}}\" | summarize arg_max(TimestampUTC, *) by ConnectorId | project IsEnabled",
        "MetricType": "Counter"
      },
      // Add more queries as needed
    ]
  }
}

```
