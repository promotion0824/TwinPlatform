parameters:
  - name: buildNumber
    type: string
  - name: id
    type: string
  - name: namespace
    type: string
  - name: cluster
    type: string
  - name: resourceGroup
    type: string
  - name: acr
    type: string
    default: 'prodplatformsharedcr.azurecr.io'
  - name: subscriptionEndpoint
    type: string
    default: 'az-products-shared-Twin Platform'

steps:
- checkout: none
- task: Kubernetes@1
  displayName: 'kubectl version'
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscriptionEndpoint: '${{ parameters.subscriptionEndpoint }}'
    azureResourceGroup: '${{ parameters.resourceGroup }}'
    kubernetesCluster: '${{ parameters.cluster }}'
    useClusterAdmin: true
    namespace: '${{ parameters.namespace }}'
    versionSpec: '1.22.5'
    command: version
    arguments: ''
- task: Kubernetes@1
  displayName: 'kubectl set image for processor'
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscriptionEndpoint: '${{ parameters.subscriptionEndpoint }}'
    azureResourceGroup: '${{ parameters.resourceGroup }}'
    kubernetesCluster: '${{ parameters.cluster }}'
    useClusterAdmin: true
    namespace: '${{ parameters.namespace }}'
    command: set
    arguments: 'image deployment/rules-engine-processor rules-engine-processor=${{ parameters.acr }}/rules-engine/processor:$(Build.BuildNumber)'
    versionSpec: '1.22.5'
# - task: Kubernetes@1
#   displayName: 'kubectl set env deployment/rules-engine-processor TESTSET=test-set'
#   inputs:
#     connectionType: 'Azure Resource Manager'
#     azureSubscriptionEndpoint: '${{ parameters.subscriptionEndpoint }}'
#     azureResourceGroup: '${{ parameters.resourceGroup }}'
#     kubernetesCluster: '${{ parameters.cluster }}'
#     useClusterAdmin: true
#     namespace: '${{ parameters.namespace }}'
#     command: set
#     arguments: 'env deployment/rules-engine-processor TESTSET=test-set'
#     versionSpec: '1.22.5'
- task: Kubernetes@1
  displayName: 'kubectl rollout restart processor'
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscriptionEndpoint: '${{ parameters.subscriptionEndpoint }}'
    azureResourceGroup: '${{ parameters.resourceGroup }}'
    kubernetesCluster: '${{ parameters.cluster }}'
    useClusterAdmin: true
    namespace: '${{ parameters.namespace }}'
    command: rollout
    arguments: 'restart deployment/rules-engine-processor'
    versionSpec: '1.22.5'
- task: Kubernetes@1
  displayName: 'kubectl set image for web'
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscriptionEndpoint: '${{ parameters.subscriptionEndpoint }}'
    azureResourceGroup: '${{ parameters.resourceGroup }}'
    kubernetesCluster: '${{ parameters.cluster }}'
    useClusterAdmin: true
    namespace: '${{ parameters.namespace }}'
    command: set
    arguments: 'image deployment/rules-engine-web rules-engine-web=${{ parameters.acr }}/rules-engine/web:$(Build.BuildNumber)'
    versionSpec: '1.22.5'
- task: Kubernetes@1
  displayName: 'kubectl rollout restart web'
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscriptionEndpoint: '${{ parameters.subscriptionEndpoint }}'
    azureResourceGroup: '${{ parameters.resourceGroup }}'
    kubernetesCluster: '${{ parameters.cluster }}'
    useClusterAdmin: true
    namespace: '${{ parameters.namespace }}'
    command: rollout
    arguments: 'restart deployment/rules-engine-web'
    versionSpec: '1.22.5'
