parameters:
  - name: dockerfile
    type: string
  - name: dockerContext
    type: string
  - name: imageName
    type: string

steps:
  - task: Bash@3
    displayName: "Get image tag based on branch name"
    inputs:
      targetType: "inline"
      script: |
        echo "##vso[task.setvariable variable=imageRepository]${{ parameters.imageName }}"
        echo "[Bash] Make Docker Tag From Branch name"
        branch=$(Build.SourceBranch)
        branchtag=${branch//[\/]/_}
        branchtagshort=${branchtag//refs_heads_/}
        echo "Tag will be $branchtagshort"
        echo "##vso[task.setvariable variable=branchtagshort;]$branchtagshort"

  - task: Docker@2
    displayName: "Build image"
    inputs:
      command: build
      dockerfile: ${{ parameters.dockerfile }}
      containerRegistry: acr-nonprod-platformshared-Twin Platform
      repository: $(imageRepository)
      buildContext: ${{ parameters.dockerContext }}
      # supply the nuget token set by the nuget authenticate step
      # https://stackoverflow.com/a/65788814/224370
      arguments: ''
      tags: |
        $(Build.BuildNumber)
        latest
        $(branchtagshort)

  - task: Docker@2
    displayName: "Push image to nonprod ACR"
    inputs:
      command: push
      containerRegistry: acr-nonprod-platformshared-Twin Platform
      repository: $(imageRepository)
      buildContext: ${{ parameters.dockerContext }}
      tags: |
        $(Build.BuildNumber)
        latest
        $(branchtagshort)

