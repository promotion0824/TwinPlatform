trigger:
  branches:
    include:
      - main
      - releases/real-estate/*
  paths:
    include:
      - extensions/real-estate/back-end/Scheduler/*

pr:
  branches:
    include:
      - main
      - releases/real-estate/*
  paths:
    include:
      - extensions/real-estate/back-end/Scheduler/*

parameters:
- name: acr_push_prd
  displayName: Push to ACR (PRD)
  type: boolean
  default: false
- name: acr_push_dev
  displayName: Push to ACR (DEV)
  type: boolean
  default: false

variables:
  - name: buildConfiguration
    value: 'Release'
  - name: majorVersion # This is used to determine keyvault prefix within PrefixKeyVaultSecretManager
    value: '1'
  - name: projectPath
    value: extensions/real-estate/back-end/Scheduler
  - name: srcRoot
    value: $(Build.SourcesDirectory)/$(projectPath)
  - name: srcProjectDir
    value: $(projectPath)/Scheduler
  - name: testProjectDir
    value: $(projectPath)/Scheduler.Test

resources:
  repositories:
    - repository: infrastructure
      type: github
      name: Willowinc/AzurePlatform
      endpoint: github.com_willow-github-svc-Twin Platform

stages:
  - stage: Build
    jobs:
      - job: BuildArtifactsJob
        pool:
          vmImage: 'Ubuntu-latest'

        steps:
        - template: ../../../../libraries/scripts/semantic-build-numbers-template.yml
          parameters:
            majorVersion: $(majorVersion)

        - template: ../../../../libraries/scripts/dotnet-build-test-publish.yml
          parameters:
            srcProjectDir: $(srcProjectDir)
            testProjectDir: $(testProjectDir)
            zipAfterPublish: true
            preBuildSteps: 
              - task: DotNetCoreCLI@2
                displayName: Restore NuGet packages
                inputs:
                  command: restore
                  projects: |
                    $(srcProjectDir)
                    $(testProjectDir)
                  feedsToUse: select
                  vstsFeed: WillowLib/WillowLib
                  noCache: true
                  includeNuGetOrg: true
                  verbosityRestore: '-'

        - template: ../../../../libraries/scripts/docker-push-template.yml
          parameters:
            imageName: scheduler
            productName: willowplatform
            dockerfile: $(srcRoot)/Scheduler/Dockerfile
            dockerContext: $(srcRoot)/Scheduler
            branchTags: true
            alwaysPush: true
   
        - task: PublishBuildArtifacts@1

        - ${{if parameters.acr_push_dev }}:
          - template: ../../../../libraries/scripts/docker-push-template.yml
            parameters:
              imageName: scheduler
              productName: willowplatform
              dockerfile: $(srcRoot)/Scheduler/Dockerfile
              dockerContext: $(srcRoot)/Scheduler
              branchTags: true
              alwaysPush: true
              containerRegistry: acr-crwildevshared01-Twin Platform

        - ${{if parameters.acr_push_prd }}:
          - template: ../../../../libraries/scripts/docker-push-template.yml
            parameters:
              imageName: scheduler
              productName: willowplatform
              dockerfile: $(srcRoot)/Scheduler/Dockerfile
              dockerContext: $(srcRoot)/Scheduler
              branchTags: true
              alwaysPush: true
              containerRegistry: acr-crwilprdshared01-Twin Platform
